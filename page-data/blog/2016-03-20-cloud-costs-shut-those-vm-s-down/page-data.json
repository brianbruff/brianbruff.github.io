{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/2016-03-20-cloud-costs-shut-those-vm-s-down/","result":{"data":{"markdownRemark":{"html":"<p>The public cloud is fantastic for numerous reasons, if you’re not faced with some restriction such as where you data lives or other factors, then my advise is get away from private clouds and get to the public clouds as fast as your legs can carry you!</p>\n<p>However once you’re there it’s not all plain sailing, if you let a team of people loose to play with with all these new toys, on the back of your company’s credit card, then costs can start to accumulate very quickly!</p>\n<p>Sometimes, your VM’s are not being used for production and what invariably happens, is that these machines get forgotten about or are left running for no good reason, now while there are a few ways to capture such scenarios, what I’ll show you now is a very quick way of scheduling those known VM’s to shutdown (or start up) as on a predefined schedule,</p>\n<h2>AWS</h2>\n<p>For AWS the easiest way of scheduling a single standalone VM to shutdown is to use the AWS Data Pipeline service.  <img src=\"/images/./image.axd?picture=image_thumb_395.png\" alt=\"\"></p>\n<p>Lets quickly show the workflow:</p>\n<ol>\n<li>Create new Pipeline with CLI Command</li>\n</ol>\n<p><img src=\"/images/./image.axd?picture=image_thumb_396.png\" alt=\"\"></p>\n<ol start=\"2\">\n<li>Enter the Stop EC2 CLI commands</li>\n</ol>\n<p><img src=\"/images/./image.axd?picture=image_thumb_397.png\" alt=\"\"></p>\n<p>Note: This field only shows as one line of text vertically in chrome so I modified to styles to show the full command.</p>\n<p>You can see that i have two different stop commands, I could combine these into the one command with the two IDs however if one fails then they both fail, this can be problematic if for example an Instance gets terminated.</p>\n<ol start=\"3\">\n<li>Schedule</li>\n</ol>\n<p><img src=\"/images/./image.axd?picture=image_thumb_398.png\" alt=\"\"></p>\n<ol start=\"4\">\n<li>Set log file bucket</li>\n</ol>\n<p><img src=\"/images/./image.axd?picture=image_thumb_399.png\" alt=\"\"></p>\n<ol start=\"5\">\n<li>Select role</li>\n</ol>\n<p><img src=\"/images/./image.axd?picture=image_thumb_400.png\" alt=\"\"></p>\n<p>Choose custom and then select the two defaults.<br>\n<em>Security Note:</em> Roles needs to be configured to allow Data Pipeline access to your VM’s, please see here: <a href=\"https://aws.amazon.com/premiumsupport/knowledge-center/stop-start-ec2-instances/\">https://aws.amazon.com/premiumsupport/knowledge-center/stop-start-ec2-instances/</a></p>\n<ol start=\"6\">\n<li>Done</li>\n</ol>\n<p><img src=\"/images/./image.axd?picture=image_thumb_401.png\" alt=\"\"></p>\n<p>That’s it, you now have a scheduled task that will switch off your vm’s nightly. It should be noted that this will start a micro data pipeline ec2 instance VM with a default run time of 50 minutes, so you need to ensure the end justifies the means, better yet reduce the run time by editing the workflow to e.g. 15 minutes.</p>\n<p><img src=\"/images/./image.axd?picture=image_thumb_402.png\" alt=\"\"></p>\n<h2></h2>\n<h2>Azure</h2>\n<p>In order to achieve the same results with Azure we are going to select Azure automation,  <img src=\"/images/./image.axd?picture=image_thumb_403.png\" alt=\"\"></p>\n<p>If you’re familiar with Azure you will know that there are currently two ways of creating VM’s, the classic approach and the RM (resource manager approach). In this post I’ll show you the RM approach, but feel free to substitute classic in it’s place with a nearly identical approach.</p>\n<ol>\n<li>Open or create an Azure Automation account.</li>\n</ol>\n<p><img src=\"/images/./image.axd?picture=image_thumb_404.png\" alt=\"\"></p>\n<ol start=\"2\">\n<li>Edit Assets</li>\n</ol>\n<p><img src=\"/images/./image.axd?picture=image%5B95%5D_thumb.png\" alt=\"\"></p>\n<p><img src=\"/images/./image.axd?picture=image_thumb_405.png\" alt=\"\"></p>\n<p>Add a variable for the AzureSubscriptionId you’ll be using<br>\nSelect your service principle account, you’ll have to search for it to appear.</p>\n<ol start=\"3\">\n<li>Runbook</li>\n</ol>\n<p>We have two options now, we can either use some powershell or some graphically defined workflows, let’s do this with a graphical version, we don’t need to create this, we simply import from the gallery.</p>\n<p><img src=\"/images/./image.axd?picture=image_thumb_406.png\" alt=\"\"></p>\n<p><img src=\"/images/./image.axd?picture=image_thumb_407.png\" alt=\"\"></p>\n<p>After importing choose Edit on the runbook</p>\n<p><img src=\"/images/./image.axd?picture=image_thumb_408.png\" alt=\"\"></p>\n<p><img src=\"/images/./image.axd?picture=image_thumb_409.png\" alt=\"\"></p>\n<p>__</p>\n<ol start=\"4\">\n<li>Set inputs</li>\n</ol>\n<p><img src=\"/images/./image.axd?picture=image_thumb_410.png\" alt=\"\"></p>\n<p>Then we set the two Assets we provided earlier and optionally a ResourceGroupName (to stop all vm’s in a resource group) or a VMName The “Auto” you see above isn’t a keyword, it’s my badly named ResourceGroup.</p>\n<ol start=\"5\">\n<li>Publish</li>\n</ol>\n<p><img src=\"/images/./image.axd?picture=image_thumb_411.png\" alt=\"\"></p>\n<ol start=\"6\">\n<li>Set schedule</li>\n</ol>\n<p>Go back to the Runbook and choose schedule</p>\n<p><img src=\"/images/./image.axd?picture=image_thumb_412.png\" alt=\"\"></p>\n<p>With the schedule you can specify any of the input parameters and override the defaults if you so wish.</p>\n<p><em>Security Note:</em> Much the same as Azure you’ll need to ensure you’ve permission to access the VM’s from Azure Automation, the best option is to create a SecurityPrinciple application. See: <a href=\"https://azure.microsoft.com/en-us/documentation/articles/resource-group-create-service-principal-portal/\">https://azure.microsoft.com/en-us/documentation/articles/resource-group-create-service-principal-portal/</a></p>\n<h2>Conclusion:</h2>\n<p>While it does look like the Azure approach is much more convoluted it is much more powerful, e.g. it is very easy to extend the azure run book to check all VM’s for a “Production” tag and only shutdown vm’s if they are not production (because that would be bad right!); with AWS, we are simply relying on a feature of Data Pipeline that allows us to run simple cli commands.</p>\n<p>Pricing is much of a much-ness between each, with Azure you can run for free (to a limit)</p>\n<p><img src=\"/images/./image.axd?picture=image_thumb_413.png\" alt=\"\"></p>\n<p>AWS the 15 mins with a micro instance is not even worth worrying about.</p>","frontmatter":{"title":"Cloud costs: Shut those VM’s down","date":"March 20, 2016"}}},"pageContext":{"slug":"/blog/2016-03-20-cloud-costs-shut-those-vm-s-down/"}},"staticQueryHashes":["2326376460","63159454"],"slicesMap":{}}