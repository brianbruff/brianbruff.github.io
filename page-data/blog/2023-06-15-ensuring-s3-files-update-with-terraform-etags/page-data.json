{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/2023-06-15-ensuring-s3-files-update-with-terraform-etags/","result":{"data":{"markdownRemark":{"html":"<h2>The Challenge with S3 File Updates in Terraform</h2>\n<p>When managing infrastructure as code with Terraform, one common challenge is ensuring that file content in S3 buckets actually updates when the source files change. By default, Terraform will upload a file to S3 once but may not detect content changes in subsequent runs. This can be particularly frustrating when you're updating scripts, configuration files, or other assets that your infrastructure depends on.</p>\n<h2>Understanding the Problem</h2>\n<p>Consider this simple Terraform resource that uploads a Python script to an S3 bucket:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-hcl line-numbers\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_s3_object\"</span></span> <span class=\"token string\">\"python_script\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">bucket</span> <span class=\"token punctuation\">=</span> aws_s3_bucket.data_processing_bucket.bucket\n  <span class=\"token property\">key</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"scripts/process_data.py\"</span>\n  <span class=\"token property\">source</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"../scripts/process_data.py\"</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This works fine initially. However, let's say you update the Python script with important fixes or enhancements. When you run <code class=\"language-text\">terraform apply</code> again, Terraform might not detect that the source file has changed, and therefore won't update the file in S3. This happens because Terraform is tracking the resource's configuration, not the content of the source file.</p>\n<h2>The Solution: Using etags with filemd5()</h2>\n<p>To solve this problem, we can use the <code class=\"language-text\">etag</code> attribute with Terraform's <code class=\"language-text\">filemd5()</code> function. The etag acts as a fingerprint of the file's content, changing whenever the file content changes:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-hcl line-numbers\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_s3_object\"</span></span> <span class=\"token string\">\"python_script\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">bucket</span> <span class=\"token punctuation\">=</span> aws_s3_bucket.data_processing_bucket.bucket\n  <span class=\"token property\">key</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"scripts/process_data.py\"</span>\n  <span class=\"token property\">source</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"../scripts/process_data.py\"</span>\n  <span class=\"token property\">etag</span>   <span class=\"token punctuation\">=</span> filemd5(<span class=\"token string\">\"../scripts/process_data.py\"</span>)\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>With this addition, whenever the content of <code class=\"language-text\">process_data.py</code> changes, the MD5 hash calculated by <code class=\"language-text\">filemd5()</code> will change. This new etag value will then trigger Terraform to update the S3 object during the next apply.</p>\n<h2>Real-World Example</h2>\n<p>Here's a more comprehensive example from a data processing pipeline:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-hcl line-numbers\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_s3_object\"</span></span> <span class=\"token string\">\"glue_news_extract_python_script\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">bucket</span> <span class=\"token punctuation\">=</span> aws_s3_bucket.brian_news_infra.bucket\n  <span class=\"token property\">key</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"glue/news/brian_news/scripts/extract-history-bronze.py\"</span>\n  <span class=\"token property\">source</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"../../brian_news/glue/scripts/extract-history-bronze.py\"</span>\n  <span class=\"token property\">etag</span>   <span class=\"token punctuation\">=</span> filemd5(<span class=\"token string\">\"../../brian_news/glue/scripts/extract-history-bronze.py\"</span>)\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_s3_object\"</span></span> <span class=\"token string\">\"glue_config_json\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">bucket</span> <span class=\"token punctuation\">=</span> aws_s3_bucket.brian_news_infra.bucket\n  <span class=\"token property\">key</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"glue/news/brian_news/config/settings.json\"</span>\n  <span class=\"token property\">source</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"../../brian_news/glue/config/settings.json\"</span>\n  <span class=\"token property\">etag</span>   <span class=\"token punctuation\">=</span> filemd5(<span class=\"token string\">\"../../brian_news/glue/config/settings.json\"</span>)\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>In this example, both the Python script and a JSON configuration file will be updated in S3 whenever their content changes.</p>\n<h2>Understanding filemd5()</h2>\n<p>The <code class=\"language-text\">filemd5()</code> function in Terraform:</p>\n<ol>\n<li>Reads the file from disk</li>\n<li>Calculates its MD5 hash</li>\n<li>Returns the hash as a hex-encoded string</li>\n</ol>\n<p>This MD5 hash acts as a unique identifier for the file's content, changing if even a single byte in the file changes.</p>\n<h2>Best Practices</h2>\n<p>When using etags with S3 objects:</p>\n<ol>\n<li><strong>Always use the same path</strong> for both the <code class=\"language-text\">source</code> and <code class=\"language-text\">etag</code> parameters to ensure consistency</li>\n<li><strong>Consider using content_type</strong> if you need proper MIME types for your files:\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-hcl line-numbers\"><code class=\"language-hcl\"><span class=\"token property\">content_type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"application/python\"</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n</li>\n<li><strong>Add server-side encryption</strong> for sensitive files:\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-hcl line-numbers\"><code class=\"language-hcl\"><span class=\"token property\">server_side_encryption</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"AES256\"</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n</li>\n<li><strong>Be aware of large files</strong> - calculating MD5 hashes for very large files might impact performance during Terraform planning</li>\n</ol>\n<h2>Conclusion</h2>\n<p>Using the <code class=\"language-text\">etag</code> attribute with <code class=\"language-text\">filemd5()</code> is a simple but powerful technique to ensure your S3 files stay in sync with their sources when managed by Terraform. This approach makes your infrastructure as code more reliable by ensuring that content changes are always properly deployed.</p>\n<p>Next time you're managing files in S3 with Terraform, remember to add that etag to avoid the frustration of unchanged files!</p>","frontmatter":{"title":"Ensuring S3 Files Update with Terraform: The Power of etags","date":"June 15, 2023"}}},"pageContext":{"slug":"/blog/2023-06-15-ensuring-s3-files-update-with-terraform-etags/"}},"staticQueryHashes":["2326376460","63159454"],"slicesMap":{}}