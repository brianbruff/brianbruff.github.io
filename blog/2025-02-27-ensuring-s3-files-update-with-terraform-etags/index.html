<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.14.1"/><meta name="theme-color" content="#333333"/><meta name="description" content="Technical insights and experiences from a Software Architect, Developer, and Engineer. Exploring software architecture, development practices, and engineering solutions." data-gatsby-head="true"/><meta property="og:title" content="Ensuring S3 Files Update with Terraform: The Power of etags" data-gatsby-head="true"/><meta property="og:description" content="Technical insights and experiences from a Software Architect, Developer, and Engineer. Exploring software architecture, development practices, and engineering solutions." data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta name="twitter:card" content="summary" data-gatsby-head="true"/><meta name="twitter:creator" content="@briankeating" data-gatsby-head="true"/><meta name="twitter:title" content="Ensuring S3 Files Update with Terraform: The Power of etags" data-gatsby-head="true"/><meta name="twitter:description" content="Technical insights and experiences from a Software Architect, Developer, and Engineer. Exploring software architecture, development practices, and engineering solutions." data-gatsby-head="true"/><style data-href="/styles.2c1bbfd9bf89f37c52b1.css" data-identity="gatsby-global-css">.gatsby-highlight{background-color:#f5f5f5;border:1px solid #e0e0e0;border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}.gatsby-highlight pre[class*=language-]{background-color:transparent;color:#000;float:left;margin:0;min-width:100%;overflow:initial;padding:0}.gatsby-highlight pre[class*=language-] code{background:none}.gatsby-highlight pre[class*=language-].line-numbers{padding-left:2.8em}.gatsby-highlight-code-line{background-color:hsla(0,0%,100%,.1);border-left:.25em solid #007acc;display:block;margin:0 -1.5rem;padding:0 1.5rem}.token{background:none!important}.gatsby-highlight pre[class*=language-]:before{background:#d9d7e0;border-radius:0 0 4px 4px;color:#232129;font-family:monospace;font-size:.75rem;letter-spacing:.075em;line-height:1;padding:.25rem .5rem;position:absolute;right:1rem;text-align:right;text-transform:uppercase;top:0}:root{--code-bg:#1a1a1a;--code-text:#fff;--inline-code-bg:#f3f4f6;--inline-code-text:#0070f3}pre[class*=language-]{background:var(--code-bg);border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,.1);color:var(--code-text);font-size:.95rem;line-height:1.6;margin:2rem 0;padding:1.5rem}:not(pre)>code[class*=language-]{background:var(--inline-code-bg);border-radius:4px;color:var(--inline-code-text);font-size:.9em;font-weight:500;padding:.2em .4em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#a0aec0}.token.punctuation{color:#e2e8f0}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#00c6ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#9ae6b4}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#cbd5e0}.token.atrule,.token.attr-value,.token.keyword{color:#00c6ff}.token.class-name,.token.function{color:#ffd600}.token.important,.token.regex,.token.variable{color:#ff8a4c}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#ccc;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}pre[class*=language-].line-numbers{counter-reset:linenumber;padding-left:3.8em;position:relative}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{border-right:1px solid #999;font-size:100%;left:-3.8em;letter-spacing:-1px;pointer-events:none;position:absolute;top:0;-webkit-user-select:none;user-select:none;width:3em}.line-numbers-rows>span{counter-increment:linenumber;display:block}.line-numbers-rows>span:before{color:#999;content:counter(linenumber);display:block;padding-right:.8em;text-align:right}.header-module--header--666b3{-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);background:var(--primary-gradient);box-shadow:0 4px 20px rgba(0,0,0,.08);padding:1.25rem 0;position:sticky;top:0;z-index:1000}.header-module--headerContent--d7417{align-items:center;display:flex;justify-content:space-between;margin:0 auto;max-width:1200px;padding:0 2rem}.header-module--logo--9932e{color:#fff;font-size:1.75rem;font-weight:800;letter-spacing:-.02em;text-decoration:none;text-shadow:0 2px 4px rgba(0,0,0,.12);transition:all .3s ease}.header-module--logo--9932e:hover{color:hsla(0,0%,100%,.95);transform:translateY(-1px)}.header-module--nav--7bc38{align-items:center;display:flex;gap:2.5rem}.header-module--navLink--8864e{color:hsla(0,0%,100%,.9);font-size:1.1rem;font-weight:600;padding:.5rem 0;position:relative;text-decoration:none;transition:all .3s ease}.header-module--navLink--8864e:after{background-color:#fff;bottom:0;content:"";height:2px;left:0;position:absolute;transform:scaleX(0);transform-origin:bottom right;transition:transform .3s cubic-bezier(.4,0,.2,1);width:100%}.header-module--navLink--8864e:hover{color:#fff;transform:translateY(-1px)}.header-module--navLink--8864e:hover:after{transform:scaleX(1);transform-origin:bottom left}.layout-module--container--78b04{background:linear-gradient(180deg,#fff,#f7fafc);display:flex;flex-direction:column;min-height:100vh}.layout-module--content--2bfc1{flex:1 1;margin:0 auto;max-width:1200px;padding:3rem 2rem;width:100%}.layout-module--footer--ad7d0{background:#fff;border-top:1px solid rgba(0,0,0,.05);color:var(--text-light);margin-top:6rem;padding:3rem 0;text-align:center}.layout-module--footerLinks--b238e{font-size:1.1rem;margin-top:1rem}.layout-module--footerLinks--b238e a{color:var(--primary-color);font-weight:500;text-decoration:none;transition:all .3s ease}.layout-module--footerLinks--b238e a:hover{color:var(--text-color)}.layout-module--divider--2b8a7{color:var(--text-light);margin:0 1rem}@media (max-width:768px){.layout-module--content--2bfc1{padding:2rem 1.5rem}.layout-module--footer--ad7d0{margin-top:4rem;padding:2rem 1rem}}:root{--primary-color:#0070f3;--primary-gradient:linear-gradient(135deg,#0070f3,#00c6ff);--text-color:#1a202c;--text-light:#4a5568;--background:#fff;--card-shadow:0 4px 6px rgba(0,0,0,.05);--hover-shadow:0 10px 20px rgba(0,0,0,.08)}.index-module--list--fb407{display:grid;gap:2.5rem;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));margin:3rem 0}.index-module--listItem--06e6d{background:var(--background);border:1px solid rgba(0,0,0,.05);border-radius:12px;box-shadow:var(--card-shadow);padding:2rem;transition:all .3s cubic-bezier(.4,0,.2,1)}.index-module--listItem--06e6d:hover{border-color:rgba(0,112,243,.2);box-shadow:var(--hover-shadow);transform:translateY(-4px)}.index-module--listItem--06e6d::marker{color:#e95800}.index-module--listItem--06e6d:nth-child(2)::marker{color:#159bf3}.index-module--listItem--06e6d:nth-child(3)::marker{color:#8eb814}.index-module--listItem--06e6d:nth-child(4)::marker{color:#639}.index-module--listItemLink--02c9e{color:var(--text-color);display:block;font-size:1.5rem;font-weight:700;line-height:1.4;margin-bottom:.5rem;text-decoration:none}.index-module--listItemLink--02c9e:hover{color:var(--primary-color)}.index-module--listItemDescription--f3875{color:var(--text-light);font-size:1.1rem;line-height:1.7;margin:1rem 0}.index-module--textCenter--4ece3{margin:4rem 0;text-align:center}.index-module--intro--0b876{color:var(--text-light);font-size:1.25rem;line-height:1.8;margin:2rem auto;max-width:48rem}.index-module--button--73561{background:var(--primary-gradient);border-radius:8px;color:#fff;display:inline-block;font-size:1.1rem;font-weight:600;padding:.875rem 2rem;text-decoration:none;transition:all .3s cubic-bezier(.4,0,.2,1)}.index-module--button--73561:hover{box-shadow:0 6px 16px rgba(0,112,243,.25);transform:translateY(-2px)}.index-module--blogPost--c2650{margin:2rem auto;max-width:42rem;padding:0 1.5rem}.index-module--blogPostMeta--a9723{color:var(--text-light);font-size:.875rem}.index-module--blogPostContent--6bc89{color:var(--text-color);line-height:1.8}.index-module--blogPostContent--6bc89 h1,.index-module--blogPostContent--6bc89 h2,.index-module--blogPostContent--6bc89 h3{color:var(--text-color);margin:2rem 0 1rem}.index-module--blogPostContent--6bc89 pre{background:#f8f9fa;border-radius:8px;margin:1.5rem 0;overflow-x:auto;padding:1.5rem}.index-module--blogPostContent--6bc89 code{background:#f1f3f5;border-radius:4px;color:var(--primary-color);font-size:.875em;padding:.2em .4em}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/favicon-32x32.png?v=49d82e8368d383559e89abf88702c5c0" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=49d82e8368d383559e89abf88702c5c0"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=49d82e8368d383559e89abf88702c5c0"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=49d82e8368d383559e89abf88702c5c0"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=49d82e8368d383559e89abf88702c5c0"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=49d82e8368d383559e89abf88702c5c0"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=49d82e8368d383559e89abf88702c5c0"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=49d82e8368d383559e89abf88702c5c0"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=49d82e8368d383559e89abf88702c5c0"/><title data-gatsby-head="true">Ensuring S3 Files Update with Terraform: The Power of etags | Brian Keating&#x27;s Tech Blog</title></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout-module--container--78b04"><header class="header-module--header--666b3"><div class="header-module--headerContent--d7417"><a class="header-module--logo--9932e" href="/">Brian Keating&#x27;s Tech Blog</a><nav class="header-module--nav--7bc38"><a class="header-module--navLink--8864e" href="/blog/">Blog</a><a href="https://github.com/brianbruff" target="_blank" rel="noopener noreferrer" class="header-module--navLink--8864e">GitHub</a></nav></div></header><div class="layout-module--content--2bfc1"><main><article class="index-module--blogPost--c2650"><header><h1>Ensuring S3 Files Update with Terraform: The Power of etags</h1><p class="index-module--blogPostMeta--a9723">February 27, 2025</p></header><section class="index-module--blogPostContent--6bc89"><h2>The Challenge with S3 File Updates in Terraform</h2>
<p>When managing infrastructure as code with Terraform, one common challenge is ensuring that file content in S3 buckets actually updates when the source files change. By default, Terraform will upload a file to S3 once but may not detect content changes in subsequent runs. This can be particularly frustrating when you're updating scripts, configuration files, or other assets that your infrastructure depends on.</p>
<h2>Understanding the Problem</h2>
<p>Consider this simple Terraform resource that uploads a Python script to an S3 bucket:</p>
<div class="gatsby-highlight" data-language="hcl"><pre style="counter-reset: linenumber NaN" class="language-hcl line-numbers"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"aws_s3_object"</span></span> <span class="token string">"python_script"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> aws_s3_bucket.data_processing_bucket.bucket
  <span class="token property">key</span>    <span class="token punctuation">=</span> <span class="token string">"scripts/process_data.py"</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"../scripts/process_data.py"</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>This works fine initially. However, let's say you update the Python script with important fixes or enhancements. When you run <code class="language-text">terraform apply</code> again, Terraform might not detect that the source file has changed, and therefore won't update the file in S3. This happens because Terraform is tracking the resource's configuration, not the content of the source file.</p>
<h2>The Solution: Using etags with filemd5()</h2>
<p>To solve this problem, we can use the <code class="language-text">etag</code> attribute with Terraform's <code class="language-text">filemd5()</code> function. The etag acts as a fingerprint of the file's content, changing whenever the file content changes:</p>
<div class="gatsby-highlight" data-language="hcl"><pre style="counter-reset: linenumber NaN" class="language-hcl line-numbers"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"aws_s3_object"</span></span> <span class="token string">"python_script"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> aws_s3_bucket.data_processing_bucket.bucket
  <span class="token property">key</span>    <span class="token punctuation">=</span> <span class="token string">"scripts/process_data.py"</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"../scripts/process_data.py"</span>
  <span class="token property">etag</span>   <span class="token punctuation">=</span> filemd5(<span class="token string">"../scripts/process_data.py"</span>)
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>With this addition, whenever the content of <code class="language-text">process_data.py</code> changes, the MD5 hash calculated by <code class="language-text">filemd5()</code> will change. This new etag value will then trigger Terraform to update the S3 object during the next apply.</p>
<h2>Real-World Example</h2>
<p>Here's a more comprehensive example from a data processing pipeline:</p>
<div class="gatsby-highlight" data-language="hcl"><pre style="counter-reset: linenumber NaN" class="language-hcl line-numbers"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"aws_s3_object"</span></span> <span class="token string">"glue_news_extract_python_script"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> aws_s3_bucket.brian_news_infra.bucket
  <span class="token property">key</span>    <span class="token punctuation">=</span> <span class="token string">"glue/news/brian_news/scripts/extract-history-bronze.py"</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"../../brian_news/glue/scripts/extract-history-bronze.py"</span>
  <span class="token property">etag</span>   <span class="token punctuation">=</span> filemd5(<span class="token string">"../../brian_news/glue/scripts/extract-history-bronze.py"</span>)
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_s3_object"</span></span> <span class="token string">"glue_config_json"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> aws_s3_bucket.brian_news_infra.bucket
  <span class="token property">key</span>    <span class="token punctuation">=</span> <span class="token string">"glue/news/brian_news/config/settings.json"</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"../../brian_news/glue/config/settings.json"</span>
  <span class="token property">etag</span>   <span class="token punctuation">=</span> filemd5(<span class="token string">"../../brian_news/glue/config/settings.json"</span>)
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>In this example, both the Python script and a JSON configuration file will be updated in S3 whenever their content changes.</p>
<h2>Understanding filemd5()</h2>
<p>The <code class="language-text">filemd5()</code> function in Terraform:</p>
<ol>
<li>Reads the file from disk</li>
<li>Calculates its MD5 hash</li>
<li>Returns the hash as a hex-encoded string</li>
</ol>
<p>This MD5 hash acts as a unique identifier for the file's content, changing if even a single byte in the file changes.</p>
<h2>Best Practices</h2>
<p>When using etags with S3 objects:</p>
<ol>
<li><strong>Always use the same path</strong> for both the <code class="language-text">source</code> and <code class="language-text">etag</code> parameters to ensure consistency</li>
<li><strong>Consider using content_type</strong> if you need proper MIME types for your files:
<div class="gatsby-highlight" data-language="hcl"><pre style="counter-reset: linenumber NaN" class="language-hcl line-numbers"><code class="language-hcl"><span class="token property">content_type</span> <span class="token punctuation">=</span> <span class="token string">"application/python"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
</li>
<li><strong>Add server-side encryption</strong> for sensitive files:
<div class="gatsby-highlight" data-language="hcl"><pre style="counter-reset: linenumber NaN" class="language-hcl line-numbers"><code class="language-hcl"><span class="token property">server_side_encryption</span> <span class="token punctuation">=</span> <span class="token string">"AES256"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
</li>
<li><strong>Be aware of large files</strong> - calculating MD5 hashes for very large files might impact performance during Terraform planning</li>
</ol>
<h2>Conclusion</h2>
<p>Using the <code class="language-text">etag</code> attribute with <code class="language-text">filemd5()</code> is a simple but powerful technique to ensure your S3 files stay in sync with their sources when managed by Terraform. This approach makes your infrastructure as code more reliable by ensuring that content changes are always properly deployed.</p>
<p>Next time you're managing files in S3 with Terraform, remember to add that etag to avoid the frustration of unchanged files!</p></section><hr/><footer><a class="index-module--button--73561" href="/blog/">← Back to Blog</a></footer></article></main><footer class="layout-module--footer--ad7d0">© <!-- -->2025<!-- --> Brian Keating. All rights reserved.<div class="layout-module--footerLinks--b238e"><a href="https://briankeating.net">briankeating.net</a><span class="layout-module--divider--2b8a7">·</span><a href="https://github.com/brianbruff">GitHub</a></div></footer></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/2025-02-27-ensuring-s3-files-update-with-terraform-etags/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-a8d9d91694ff9ceb2f6c.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-b43bf77f7319638a559f.js\"],\"component---src-pages-blog-js\":[\"/component---src-pages-blog-js-35f1ac5bc585c5fe8988.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-8596db803a30dd655040.js\"],\"component---src-pages-page-2-js\":[\"/component---src-pages-page-2-js-75bafa9a9e2721c0690c.js\"],\"component---src-pages-using-ssr-js\":[\"/component---src-pages-using-ssr-js-ee3f2701811722f91968.js\"],\"component---src-pages-using-typescript-tsx\":[\"/component---src-pages-using-typescript-tsx-06762b8f8912471267e3.js\"],\"component---src-templates-blog-post-js\":[\"/component---src-templates-blog-post-js-7866fec808337785220f.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="2169f859c5af67e4758f";</script><script src="/webpack-runtime-c132b01299380178b21f.js" async></script><script src="/framework-cc4c5071f2e10a424495.js" async></script><script src="/app-a8d9d91694ff9ceb2f6c.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>