<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.14.1"/><meta name="theme-color" content="#333333"/><meta name="description" content="Technical insights and experiences from a Software Architect, Developer, and Engineer. Exploring software architecture, development practices, and engineering solutions." data-gatsby-head="true"/><meta property="og:title" content="Cloud costs: Shut those VM’s down" data-gatsby-head="true"/><meta property="og:description" content="Technical insights and experiences from a Software Architect, Developer, and Engineer. Exploring software architecture, development practices, and engineering solutions." data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta name="twitter:card" content="summary" data-gatsby-head="true"/><meta name="twitter:creator" content="@briankeating" data-gatsby-head="true"/><meta name="twitter:title" content="Cloud costs: Shut those VM’s down" data-gatsby-head="true"/><meta name="twitter:description" content="Technical insights and experiences from a Software Architect, Developer, and Engineer. Exploring software architecture, development practices, and engineering solutions." data-gatsby-head="true"/><style data-href="/styles.6e5516916372d4c50f47.css" data-identity="gatsby-global-css">.gatsby-highlight{background-color:#2d2d2d;border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}.gatsby-highlight pre[class*=language-]{background-color:transparent;float:left;margin:0;min-width:100%;overflow:initial;padding:0}.gatsby-highlight pre[class*=language-].line-numbers{padding-left:2.8em}.gatsby-highlight-code-line{background-color:#464646;border-left:.25em solid #f8f8f2;display:block;margin-left:-1em;margin-right:-1em;padding-left:.75em;padding-right:1em}.gatsby-highlight pre[class*=language-]:before{background:#d9d7e0;border-radius:0 0 4px 4px;color:#232129;font-family:monospace;font-size:.75rem;letter-spacing:.075em;line-height:1;padding:.25rem .5rem;position:absolute;right:1rem;text-align:right;text-transform:uppercase;top:0}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#ccc;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}pre[class*=language-].line-numbers{counter-reset:linenumber;padding-left:3.8em;position:relative}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{border-right:1px solid #999;font-size:100%;left:-3.8em;letter-spacing:-1px;pointer-events:none;position:absolute;top:0;-webkit-user-select:none;user-select:none;width:3em}.line-numbers-rows>span{counter-increment:linenumber;display:block}.line-numbers-rows>span:before{color:#999;content:counter(linenumber);display:block;padding-right:.8em;text-align:right}.header-module--header--666b3{background:var(--primary-gradient);box-shadow:0 2px 4px rgba(0,0,0,.1);padding:1rem 0;position:sticky;top:0;z-index:1000}.header-module--headerContent--d7417{align-items:center;display:flex;justify-content:space-between;margin:0 auto;max-width:1200px;padding:0 1.5rem}.header-module--logo--9932e{color:#fff;font-size:1.5rem;font-weight:700;text-decoration:none;text-shadow:0 1px 2px rgba(0,0,0,.1)}.header-module--logo--9932e:hover{color:hsla(0,0%,100%,.9)}.header-module--nav--7bc38{align-items:center;display:flex;gap:2rem}.header-module--navLink--8864e{color:#fff;font-size:1rem;font-weight:500;padding:.5rem 0;position:relative;text-decoration:none;transition:color .2s ease}.header-module--navLink--8864e:after{background-color:#fff;bottom:0;content:"";height:2px;left:0;position:absolute;transform:scaleX(0);transform-origin:bottom right;transition:transform .3s ease;width:100%}.header-module--navLink--8864e:hover:after{transform:scaleX(1);transform-origin:bottom left}.layout-module--container--78b04{display:flex;flex-direction:column;min-height:100vh}.layout-module--content--2bfc1{flex:1 1;margin:0 auto;max-width:1200px;padding:2rem 1.5rem;width:100%}.layout-module--footer--ad7d0{border-top:1px solid #edf2f7;color:var(--text-light);margin-top:4rem;padding:2rem 0;text-align:center}.layout-module--footerLinks--b238e{margin-top:.5rem}.layout-module--footerLinks--b238e a{color:var(--primary-color);text-decoration:none;transition:color .2s ease}.layout-module--footerLinks--b238e a:hover{color:var(--text-color)}.layout-module--divider--2b8a7{color:var(--text-light);margin:0 .75rem}:root{--primary-color:#ff7b00;--primary-gradient:linear-gradient(135deg,#ff7b00,#ff9a44);--text-color:#2d3748;--text-light:#718096;--background:#fff;--card-shadow:0 4px 6px rgba(0,0,0,.1)}.index-module--list--fb407{display:grid;gap:2rem;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));margin:2rem 0}.index-module--listItem--06e6d{background:var(--background);border:none;border-radius:8px;box-shadow:var(--card-shadow);padding:1.5rem;transition:transform .2s ease,box-shadow .2s ease}.index-module--listItem--06e6d:hover{box-shadow:0 8px 15px rgba(0,0,0,.1);transform:translateY(-2px)}.index-module--listItem--06e6d::marker{color:#e95800}.index-module--listItem--06e6d:nth-child(2)::marker{color:#159bf3}.index-module--listItem--06e6d:nth-child(3)::marker{color:#8eb814}.index-module--listItem--06e6d:nth-child(4)::marker{color:#639}.index-module--listItemLink--02c9e{color:var(--text-color);font-size:1.25rem;font-weight:600;text-decoration:none}.index-module--listItemLink--02c9e:hover{color:var(--primary-color)}.index-module--listItemDescription--f3875{color:var(--text-light);line-height:1.6;margin:.75rem 0}.index-module--textCenter--4ece3{text-align:center}.index-module--intro--0b876{color:var(--text-light);font-size:1.125rem;line-height:1.8;margin:0 auto;max-width:42rem}.index-module--button--73561{background:var(--primary-gradient);border-radius:6px;color:#fff;display:inline-block;font-weight:600;padding:.75rem 1.5rem;text-decoration:none;transition:transform .2s ease,box-shadow .2s ease}.index-module--button--73561:hover{box-shadow:0 4px 12px rgba(255,123,0,.2);transform:translateY(-1px)}.index-module--blogPost--c2650{margin:2rem auto;max-width:42rem;padding:0 1.5rem}.index-module--blogPostMeta--a9723{color:var(--text-light);font-size:.875rem}.index-module--blogPostContent--6bc89{color:var(--text-color);line-height:1.8}.index-module--blogPostContent--6bc89 h1,.index-module--blogPostContent--6bc89 h2,.index-module--blogPostContent--6bc89 h3{color:var(--text-color);margin:2rem 0 1rem}.index-module--blogPostContent--6bc89 pre{background:#f8f9fa;border-radius:8px;margin:1.5rem 0;overflow-x:auto;padding:1.5rem}.index-module--blogPostContent--6bc89 code{background:#f1f3f5;border-radius:4px;color:var(--primary-color);font-size:.875em;padding:.2em .4em}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><title data-gatsby-head="true">Cloud costs: Shut those VM’s down | Brian Keating&#x27;s Tech Blog</title></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout-module--container--78b04"><header class="header-module--header--666b3"><div class="header-module--headerContent--d7417"><a class="header-module--logo--9932e" href="/">Brian Keating&#x27;s Tech Blog</a><nav class="header-module--nav--7bc38"><a class="header-module--navLink--8864e" href="/blog/">Blog</a><a href="https://github.com/brianbruff" target="_blank" rel="noopener noreferrer" class="header-module--navLink--8864e">GitHub</a></nav></div></header><div class="layout-module--content--2bfc1"><main><article class="index-module--blogPost--c2650"><header><h1>Cloud costs: Shut those VM’s down</h1><p class="index-module--blogPostMeta--a9723">March 20, 2016</p></header><section class="index-module--blogPostContent--6bc89"><p>The public cloud is fantastic for numerous reasons, if you’re not faced with some restriction such as where you data lives or other factors, then my advise is get away from private clouds and get to the public clouds as fast as your legs can carry you!</p>
<p>However once you’re there it’s not all plain sailing, if you let a team of people loose to play with with all these new toys, on the back of your company’s credit card, then costs can start to accumulate very quickly!</p>
<p>Sometimes, your VM’s are not being used for production and what invariably happens, is that these machines get forgotten about or are left running for no good reason, now while there are a few ways to capture such scenarios, what I’ll show you now is a very quick way of scheduling those known VM’s to shutdown (or start up) as on a predefined schedule,</p>
<h2>AWS</h2>
<p>For AWS the easiest way of scheduling a single standalone VM to shutdown is to use the AWS Data Pipeline service.  <img src="/images/./image.axd?picture=image_thumb_395.png" alt=""></p>
<p>Lets quickly show the workflow:</p>
<ol>
<li>Create new Pipeline with CLI Command</li>
</ol>
<p><img src="/images/./image.axd?picture=image_thumb_396.png" alt=""></p>
<ol start="2">
<li>Enter the Stop EC2 CLI commands</li>
</ol>
<p><img src="/images/./image.axd?picture=image_thumb_397.png" alt=""></p>
<p>Note: This field only shows as one line of text vertically in chrome so I modified to styles to show the full command.</p>
<p>You can see that i have two different stop commands, I could combine these into the one command with the two IDs however if one fails then they both fail, this can be problematic if for example an Instance gets terminated.</p>
<ol start="3">
<li>Schedule</li>
</ol>
<p><img src="/images/./image.axd?picture=image_thumb_398.png" alt=""></p>
<ol start="4">
<li>Set log file bucket</li>
</ol>
<p><img src="/images/./image.axd?picture=image_thumb_399.png" alt=""></p>
<ol start="5">
<li>Select role</li>
</ol>
<p><img src="/images/./image.axd?picture=image_thumb_400.png" alt=""></p>
<p>Choose custom and then select the two defaults.<br>
<em>Security Note:</em> Roles needs to be configured to allow Data Pipeline access to your VM’s, please see here: <a href="https://aws.amazon.com/premiumsupport/knowledge-center/stop-start-ec2-instances/">https://aws.amazon.com/premiumsupport/knowledge-center/stop-start-ec2-instances/</a></p>
<ol start="6">
<li>Done</li>
</ol>
<p><img src="/images/./image.axd?picture=image_thumb_401.png" alt=""></p>
<p>That’s it, you now have a scheduled task that will switch off your vm’s nightly. It should be noted that this will start a micro data pipeline ec2 instance VM with a default run time of 50 minutes, so you need to ensure the end justifies the means, better yet reduce the run time by editing the workflow to e.g. 15 minutes.</p>
<p><img src="/images/./image.axd?picture=image_thumb_402.png" alt=""></p>
<h2></h2>
<h2>Azure</h2>
<p>In order to achieve the same results with Azure we are going to select Azure automation,  <img src="/images/./image.axd?picture=image_thumb_403.png" alt=""></p>
<p>If you’re familiar with Azure you will know that there are currently two ways of creating VM’s, the classic approach and the RM (resource manager approach). In this post I’ll show you the RM approach, but feel free to substitute classic in it’s place with a nearly identical approach.</p>
<ol>
<li>Open or create an Azure Automation account.</li>
</ol>
<p><img src="/images/./image.axd?picture=image_thumb_404.png" alt=""></p>
<ol start="2">
<li>Edit Assets</li>
</ol>
<p><img src="/images/./image.axd?picture=image%5B95%5D_thumb.png" alt=""></p>
<p><img src="/images/./image.axd?picture=image_thumb_405.png" alt=""></p>
<p>Add a variable for the AzureSubscriptionId you’ll be using<br>
Select your service principle account, you’ll have to search for it to appear.</p>
<ol start="3">
<li>Runbook</li>
</ol>
<p>We have two options now, we can either use some powershell or some graphically defined workflows, let’s do this with a graphical version, we don’t need to create this, we simply import from the gallery.</p>
<p><img src="/images/./image.axd?picture=image_thumb_406.png" alt=""></p>
<p><img src="/images/./image.axd?picture=image_thumb_407.png" alt=""></p>
<p>After importing choose Edit on the runbook</p>
<p><img src="/images/./image.axd?picture=image_thumb_408.png" alt=""></p>
<p><img src="/images/./image.axd?picture=image_thumb_409.png" alt=""></p>
<p>__</p>
<ol start="4">
<li>Set inputs</li>
</ol>
<p><img src="/images/./image.axd?picture=image_thumb_410.png" alt=""></p>
<p>Then we set the two Assets we provided earlier and optionally a ResourceGroupName (to stop all vm’s in a resource group) or a VMName The “Auto” you see above isn’t a keyword, it’s my badly named ResourceGroup.</p>
<ol start="5">
<li>Publish</li>
</ol>
<p><img src="/images/./image.axd?picture=image_thumb_411.png" alt=""></p>
<ol start="6">
<li>Set schedule</li>
</ol>
<p>Go back to the Runbook and choose schedule</p>
<p><img src="/images/./image.axd?picture=image_thumb_412.png" alt=""></p>
<p>With the schedule you can specify any of the input parameters and override the defaults if you so wish.</p>
<p><em>Security Note:</em> Much the same as Azure you’ll need to ensure you’ve permission to access the VM’s from Azure Automation, the best option is to create a SecurityPrinciple application. See: <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-create-service-principal-portal/">https://azure.microsoft.com/en-us/documentation/articles/resource-group-create-service-principal-portal/</a></p>
<h2>Conclusion:</h2>
<p>While it does look like the Azure approach is much more convoluted it is much more powerful, e.g. it is very easy to extend the azure run book to check all VM’s for a “Production” tag and only shutdown vm’s if they are not production (because that would be bad right!); with AWS, we are simply relying on a feature of Data Pipeline that allows us to run simple cli commands.</p>
<p>Pricing is much of a much-ness between each, with Azure you can run for free (to a limit)</p>
<p><img src="/images/./image.axd?picture=image_thumb_413.png" alt=""></p>
<p>AWS the 15 mins with a micro instance is not even worth worrying about.</p></section><hr/><footer><a class="index-module--button--73561" href="/blog/">← Back to Blog</a></footer></article></main><footer class="layout-module--footer--ad7d0">© <!-- -->2025<!-- --> Brian Keating. All rights reserved.<div class="layout-module--footerLinks--b238e"><a href="https://briankeating.net">briankeating.net</a><span class="layout-module--divider--2b8a7">·</span><a href="https://github.com/brianbruff">GitHub</a></div></footer></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/2016-03-20-cloud-costs-shut-those-vm-s-down/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-348340c93155d5d95574.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-b43bf77f7319638a559f.js\"],\"component---src-pages-blog-js\":[\"/component---src-pages-blog-js-35f1ac5bc585c5fe8988.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-8596db803a30dd655040.js\"],\"component---src-pages-page-2-js\":[\"/component---src-pages-page-2-js-75bafa9a9e2721c0690c.js\"],\"component---src-pages-using-ssr-js\":[\"/component---src-pages-using-ssr-js-ee3f2701811722f91968.js\"],\"component---src-pages-using-typescript-tsx\":[\"/component---src-pages-using-typescript-tsx-06762b8f8912471267e3.js\"],\"component---src-templates-blog-post-js\":[\"/component---src-templates-blog-post-js-7866fec808337785220f.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="d847adaaad777bb1867c";</script><script src="/webpack-runtime-2e3e0fd85a165286ff7e.js" async></script><script src="/framework-cc4c5071f2e10a424495.js" async></script><script src="/app-348340c93155d5d95574.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>