<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<post>
  <author>brianbruff</author>
  <title>Cloud costs: Shut those VM’s down</title>
  <description />
  <content>&lt;p&gt;The public cloud is fantastic for numerous reasons, if you’re not faced with some restriction such as where you data lives or other factors, then my advise is get away from private clouds and get to the public clouds as fast as your legs can carry you!&lt;/p&gt;  &lt;p&gt;However once you’re there it’s not all plain sailing, if you let a team of people loose to play with with all these new toys, on the back of your company’s credit card, then costs can start to accumulate very quickly! &lt;/p&gt;  &lt;p&gt;Sometimes, your VM’s are not being used for production and what invariably happens, is that these machines get forgotten about or are left running for no good reason, now while there are a few ways to capture such scenarios,&amp;#160; what I’ll show you now is a very quick way of scheduling those known VM’s to shutdown (or start up) as on a predefined schedule,&lt;/p&gt;  &lt;h2&gt;AWS&lt;/h2&gt;  &lt;p&gt;For AWS the easiest way of scheduling a single standalone VM to shutdown is to use the AWS Data Pipeline service.    &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;       &lt;tr&gt;         &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_394.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_395.png" width="244" height="35" /&gt;&lt;/a&gt;&lt;/td&gt;       &lt;/tr&gt;     &lt;/tbody&gt;&lt;/table&gt; &lt;/p&gt;  &lt;p&gt;Lets quickly show the workflow:&lt;/p&gt;  &lt;p&gt;1) Create new Pipeline with CLI Command&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_395.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_396.png" width="631" height="297" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;&amp;#160;&lt;/p&gt;  &lt;p&gt;2) Enter the Stop EC2 CLI commands&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_396.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_397.png" width="616" height="98" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;Note: This field only shows as one line of text vertically in chrome so I modified to styles to show the full command.&lt;/p&gt;  &lt;p&gt;   &lt;br /&gt;You can see that i have two different stop commands, I could combine these into the one command with the two IDs however if one fails then they both fail, this can be problematic if for example an Instance gets terminated.&lt;/p&gt;  &lt;p&gt;3) Schedule&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_397.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_398.png" width="542" height="204" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;&amp;#160;&lt;/p&gt;  &lt;p&gt;4) Set log file bucket&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_398.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_399.png" width="721" height="117" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;&amp;#160;&lt;/p&gt;  &lt;p&gt;5) Select role&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_399.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_400.png" width="813" height="146" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;Choose custom and then select the two defaults.    &lt;br /&gt;&lt;u&gt;Security Note:&lt;/u&gt;&amp;#160; Roles needs to be configured to allow Data Pipeline access to your VM’s, please see here: &lt;a href="https://aws.amazon.com/premiumsupport/knowledge-center/stop-start-ec2-instances/"&gt;https://aws.amazon.com/premiumsupport/knowledge-center/stop-start-ec2-instances/&lt;/a&gt;&lt;/p&gt;  &lt;p&gt;6) Done&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_400.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_401.png" width="798" height="245" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;That’s it, you now have a scheduled task that will switch off your vm’s nightly. It should be noted that this will start a micro data pipeline ec2 instance VM with a default run time of 50 minutes, so you need to ensure the end justifies the means, better yet reduce the run time by editing the workflow to e.g. 15 minutes.&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_401.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_402.png" width="790" height="259" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;h2&gt;&amp;#160;&lt;/h2&gt;  &lt;h2&gt;Azure&lt;/h2&gt;  &lt;p&gt;In order to achieve the same results with Azure we are going to select Azure automation,    &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;       &lt;tr&gt;         &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_402.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_403.png" width="109" height="30" /&gt;&lt;/a&gt;&lt;/td&gt;       &lt;/tr&gt;     &lt;/tbody&gt;&lt;/table&gt; If you’re familiar with Azure you will know that there are currently two ways of creating VM’s, the classic approach and the RM (resource manager approach). In this post I’ll show you the RM approach, but feel free to substitute classic in it’s place with a nearly identical approach. &lt;/p&gt;  &lt;p&gt;1) Open or create an Azure Automation account.&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_403.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_404.png" width="407" height="541" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;&amp;#160;&lt;/p&gt;  &lt;p&gt;2) Edit Assets&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image%5B95%5D.png"&gt;&lt;img title="image[95]" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image[95]" src="./image.axd?picture=image%5B95%5D_thumb.png" width="641" height="373" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;      &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_404.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_405.png" width="627" height="349" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;Add a variable for the AzureSubscriptionId you’ll be using    &lt;br /&gt;Select your service principle account, you’ll have to search for it to appear.&lt;/p&gt;  &lt;p&gt;3) Runbook&lt;/p&gt;  &lt;p&gt;We have two options now, we can either use some powershell or some graphically defined workflows, let’s do this with a graphical version, we don’t need to create this, we simply import from the gallery.&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_405.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_406.png" width="199" height="154" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_406.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_407.png" width="612" height="318" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;After importing choose Edit on the runbook&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_407.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_408.png" width="239" height="119" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_408.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_409.png" width="634" height="674" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;  &lt;p&gt;4) Set inputs&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_409.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_410.png" width="297" height="388" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;Then we set the two Assets we provided earlier and optionally a ResourceGroupName (to stop all vm’s in a resource group) or a VMName The “Auto” you see above isn’t a keyword, it’s my badly named ResourceGroup.&lt;/p&gt;  &lt;p&gt;5) Publish&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_410.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_411.png" width="244" height="75" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;&amp;#160;&lt;/p&gt;  &lt;p&gt;6) Set schedule&lt;/p&gt;  &lt;p&gt;Go back to the Runbook and choose schedule&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_411.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px 10px 0px 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_412.png" width="252" height="541" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;With the schedule you can specify any of the input parameters and override the defaults if you so wish.&lt;/p&gt;  &lt;p&gt;&lt;u&gt;Security Note:&lt;/u&gt; Much the same as Azure you’ll need to ensure you’ve permission to access the VM’s from Azure Automation, the best option is to create a SecurityPrinciple application. See: &lt;a title="https://azure.microsoft.com/en-us/documentation/articles/resource-group-create-service-principal-portal/" href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-create-service-principal-portal/"&gt;https://azure.microsoft.com/en-us/documentation/articles/resource-group-create-service-principal-portal/&lt;/a&gt;&lt;/p&gt;  &lt;p&gt;&amp;#160;&lt;/p&gt;  &lt;h2&gt;Conclusion:&lt;/h2&gt;  &lt;p&gt;While it does look like the Azure approach is much more convoluted it is much more powerful, e.g. it is very easy to extend the azure run book to check all VM’s for a “Production” tag and only shutdown vm’s if they are not production (because that would be bad right!); with AWS, we are simply relying on a feature of Data Pipeline that allows us to run simple cli commands. &lt;/p&gt;  &lt;p&gt;Pricing is much of a much-ness between each, with Azure you can run for free (to a limit)&lt;/p&gt;  &lt;table cellspacing="0" cellpadding="2" width="40" border="0"&gt;&lt;tbody&gt;     &lt;tr&gt;       &lt;td valign="top" width="40"&gt;&lt;a href="./image.axd?picture=image_412.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="./image.axd?picture=image_thumb_413.png" width="244" height="204" /&gt;&lt;/a&gt;&lt;/td&gt;     &lt;/tr&gt;   &lt;/tbody&gt;&lt;/table&gt;  &lt;p&gt;AWS the 15 mins with a micro instance is not even worth worrying about.&lt;/p&gt;</content>
  <ispublished>True</ispublished>
  <isdeleted>False</isdeleted>
  <iscommentsenabled>True</iscommentsenabled>
  <pubDate>2016-03-20 23:40:19</pubDate>
  <lastModified>2016-04-01 10:34:06</lastModified>
  <raters>0</raters>
  <rating>0</rating>
  <slug>Cloud-costs-Shut-those-VMs-down</slug>
  <tags>
    <tag>CloudWars</tag>
    <tag>Azure VM</tag>
    <tag>AWS EC2</tag>
    <tag>shutdown vm weekends evenings</tag>
  </tags>
  <comments />
  <categories>
    <category>0d55a24e-db67-40a3-af5b-1a77c336bece</category>
    <category>05dd30fa-4cf5-4938-897f-33c8bd526a66</category>
  </categories>
  <notifications />
</post>
